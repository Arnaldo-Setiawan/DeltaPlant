<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Force Tactical Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom Styles and Tailwind Config -->
    <style>
        :root {
            --primary: #1d9bf0;
            --secondary: #2e4964;
            --background: #0d1117;
            --card: #161b22;
            --text: #c9d1d9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
        }

        .map-container {
            position: relative;
            aspect-ratio: 16 / 9; /* Maintain aspect ratio */
            background-color: var(--card);
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .map-canvas, #map-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            user-select: none;
            touch-action: none;
        }

        .map-canvas {
            z-index: 20;
        }
        
        #map-background {
            z-index: 10;
            object-fit: contain;
        }

        /* Brush Preview Styles */
        #brush-preview {
            mix-blend-mode: difference; /* Helps visibility against dark/light backgrounds */
            box-sizing: border-box;
            background-color: transparent;
        }

        /* Utility class for icon placement */
        .placed-icon {
            position: absolute;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50%;
            cursor: move;
            z-index: 30;
            transition: transform 0.1s ease;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        .placed-text {
            position: absolute;
            font-size: 16px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            cursor: move;
            z-index: 30;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
        }

        .active-tool {
            box-shadow: 0 0 0 3px var(--primary);
            background-color: #1a71af !important;
        }

        .tool-button {
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #333;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 50;
        }
        .tool-button:hover .tooltip {
            visibility: visible;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary)',
                        secondary: 'var(--secondary)',
                        background: 'var(--background)',
                        card: 'var(--card)',
                        text: 'var(--text)',
                    },
                }
            }
        }
    </script>
</head>
<body>

    <div id="app-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- AUTHENTICATION UI (Visible by default) -->
        <div id="auth-ui" class="w-full max-w-xs p-5 bg-card shadow-2xl rounded-xl border border-secondary transition-opacity duration-300">
            <h3 id="auth-title" class="text-2xl font-bold text-text mb-5 text-center">
                Member Login
            </h3>
            
            <div id="auth-message-box" class="hidden p-3 mb-4 text-sm font-medium rounded-lg"></div>

            <form id="auth-form" class="space-y-4">
                <div>
                    <input
                        id="auth-email"
                        type="email"
                        required
                        class="block w-full px-4 py-2 border border-gray-600 rounded-md shadow-sm text-sm bg-gray-700 text-text placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary"
                        placeholder="Username (Email)"
                    />
                </div>
                
                <div>
                    <input
                        id="auth-password"
                        type="password"
                        required
                        class="block w-full px-4 py-2 border border-gray-600 rounded-md shadow-sm text-sm bg-gray-700 text-text placeholder-gray-400 focus:outline-none focus:ring-primary focus:border-primary"
                        placeholder="Password"
                    />
                    <p id="password-hint" class="text-xs text-gray-500 mt-1 hidden">Min 6 characters required.</p>
                </div>

                <button
                    type="submit"
                    id="auth-action-btn"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-lg text-base font-semibold text-white bg-primary hover:bg-blue-600 transition duration-150 ease-in-out"
                >
                    Log In
                </button>
            </form>

            <div class="mt-4 text-center">
                <button
                    id="auth-toggle-btn"
                    class="text-sm font-medium text-primary hover:text-blue-400"
                >
                    Don't have an account? Sign Up now.
                </button>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                Logged in as temporary user ID: <span id="anon-user-id" class="break-all">...</span>
            </p>
        </div>


        <!-- MAIN PLANNER UI (Hidden until authenticated) -->
        <div id="main-wrapper" class="pt-0 px-4 sm:px-6 text-text hidden w-full max-w-7xl">
            <header class="text-center mb-1">
                <div class="flex justify-between items-center py-2">
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-primary">Delta Force Tactical Planner</h1>
                    <button id="logout-btn" class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                        Logout
                    </button>
                </div>
                <p class="text-secondary mt-1">
                    Planning on: <span id="current-map-display" class="font-bold text-white">Loading Map...</span>
                    | Sector: <span id="current-sector-display" class="font-bold text-white">N/A</span>
                </p>
                <p class="text-xs text-yellow-400 mt-1">
                    QOL: Use <kbd class="px-1 bg-gray-600 rounded">Ctrl+Z</kbd> (Undo) and <kbd class="px-1 bg-gray-600 rounded">Ctrl+Y</kbd> (Redo)
                </p>
                <p class="text-xs text-green-400 mt-1">
                    Logged in as: <span id="logged-in-user-id" class="font-bold break-all">...</span>
                </p>
            </header>
            
            <main class="flex flex-col lg:flex-row gap-6 mt-4 lg:items-start">
                
                <!-- SIDEBAR TOOLS (1/6 width) -->
                <div class="lg:w-1/6 w-full bg-card p-4 rounded-xl shadow-lg border border-secondary h-min space-y-4">
                    
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Map Selection</h2>
                        <select id="map-select" class="w-full p-1.5 bg-gray-700 border border-gray-600 rounded-lg text-text focus:ring-primary focus:border-primary">
                            </select>
                    </div>

                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Sector Selection</h2>
                        <select id="sector-select" class="w-full p-1.5 bg-gray-700 border border-gray-600 rounded-lg text-text focus:ring-primary focus:border-primary">
                            </select>
                    </div>
                    
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Sequence Control</h2>
                        <div class="flex gap-2">
                            <select id="sequence-select" class="w-full p-1.5 bg-gray-700 border border-gray-600 rounded-lg text-text focus:ring-primary focus:border-primary">
                                </select>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Operator Placement (6 Operators)</h2>
                        <div id="operator-icons" class="flex flex-wrap gap-2 justify-center">
                            </div>
                        <p id="placement-hint-operator" class="text-xs text-gray-400 mt-2 hidden text-center">Click map to place icon.</p>
                    </div>
                    
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Utility Placement (3 Items)</h2>
                        <div id="utility-icons" class="flex flex-wrap gap-2 justify-center">
                            </div>
                        <p id="placement-hint-utility" class="text-xs text-gray-400 mt-2 hidden text-center">Click map to place utility.</p>
                    </div>
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Vehicle Placement (12 Items)</h2>
                        <div id="vehicle-icons" class="flex flex-wrap gap-2 justify-center">
                            </div>
                        <p id="placement-hint-vehicle" class="text-xs text-gray-400 mt-2 hidden text-center">Click map to place vehicle.</p>
                    </div>

                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Text Labeling</h2>
                        <input type="text" id="text-input" placeholder="Type label text here..." maxlength="30"
                                class="w-full p-1.5 bg-gray-700 border border-gray-600 rounded-lg text-text focus:ring-primary focus:border-primary">
                        <p id="placement-hint-text" class="text-xs text-gray-400 mt-1 hidden text-center">Click map to place label.</p>
                    </div>
                    
                    <div class="space-y-1.5">
                        <h2 class="text-xl font-semibold border-b border-secondary pb-1">Drawing Tools</h2>
                        
                        <div class="mb-2">
                            <label for="tool-select" class="block text-xs font-medium mb-1">Select Tool</label>
                            <div class="grid grid-cols-3 gap-1.5">
                                <button id="tool-pen" data-tool="pen" class="tool-button p-1.5 bg-primary text-white rounded-lg transition hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-primary active-tool relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18.5 13.5l-12-12"/><path d="M2 20l1.5-1.5"/></svg>
                                    <div class="tooltip top-full mt-2 left-1/2 -translate-x-1/2">Pen</div>
                                </button>
                                <button id="tool-place" data-tool="place" class="tool-button p-1.5 bg-gray-600 text-white rounded-lg transition hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <div class="tooltip top-full mt-2 left-1/2 -translate-x-1/2">Place Icon</div>
                                </button>
                                <button id="tool-text" data-tool="text" class="tool-button p-1.5 bg-gray-600 text-white rounded-lg transition hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
                                    <div class="tooltip top-full mt-2 left-1/2 -translate-x-1/2">Place Text</div>
                                </button>
                                <button id="tool-move" data-tool="move" class="tool-button p-1.5 bg-gray-600 text-white rounded-lg transition hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="M5 9l-3 3 3 3"/><path d="M22 12h-8M19 5l3 3-3 3"/><path d="M12 2v20"/><path d="M5 15l-3-3 3-3"/></svg>
                                    <div class="tooltip top-full mt-2 left-1/2 -translate-x-1/2">Move Icon/Text</div>
                                </button>
                                <button id="tool-eraser" data-tool="eraser" class="tool-button p-1.5 bg-gray-600 text-white rounded-lg transition hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12c1.1 0 2-.9 2-2V8l-6-6z"/><path d="M14 2v6h6"/></svg>
                                    <div class="tooltip top-full mt-2 left-1/2 -translate-x-1/2">Eraser (Lines Only)</div>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="line-width" class="block text-xs font-medium mb-1">Brush/Eraser Size</label>
                            <input type="range" id="line-width" min="2" max="30" value="8" class="w-full h-1.5 bg-secondary rounded-lg appearance-none cursor-pointer range-lg">
                            <span id="width-display" class="text-xs mt-1 block text-right">8px</span>
                        </div>

                        <div>
                            <label for="color-picker" class="block text-xs font-medium mb-1">Stroke/Text Color</label>
                            <input type="color" id="color-picker" value="#ff0000" class="w-full h-8 p-1 border border-secondary rounded-lg cursor-pointer">
                        </div>
                    </div>

                    <div class="pt-4 border-t border-secondary space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="undo-button" class="py-1 px-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50 text-xs" disabled>
                                Undo (Z)
                            </button>
                            <button id="redo-button" class="py-1 px-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition focus:outline-none focus:ring-2 focus:ring-gray-400 disabled:opacity-50 text-xs" disabled>
                                Redo (Y)
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button id="export-data" class="w-full py-1 px-2 bg-purple-700 text-white font-semibold rounded-lg hover:bg-purple-600 transition focus:outline-none focus:ring-2 focus:ring-purple-500 text-xs">
                                Export Plan (JSON)
                            </button>
                            <button id="import-data" class="w-full py-1 px-2 bg-indigo-700 text-white font-semibold rounded-lg hover:bg-indigo-600 transition focus:outline-none focus:ring-2 focus:ring-indigo-500 text-xs">
                                Import Plan (JSON)
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <button id="clear-lines" class="w-full py-1 px-2 bg-yellow-700 text-white font-semibold rounded-lg hover:bg-yellow-600 transition focus:outline-none focus:ring-2 focus:ring-yellow-500 text-xs">
                                Clear Lines
                            </button>
                            <button id="clear-map" class="w-full py-1 px-2 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-600 transition focus:outline-none focus:ring-2 focus:ring-red-500 text-xs">
                                Clear ALL
                            </button>
                        </div>
                        
                        <button id="save-map" class="w-full py-1 px-2 bg-green-700 text-white font-semibold rounded-lg hover:bg-green-600 transition focus:outline-none focus:ring-2 focus:ring-green-500 text-xs">
                            Save Image
                        </button>
                        <p class="text-xs text-gray-400 text-center">Saves the plan (Map + Drawings)</p>
                    </div>

                </div>

                <!-- MAP CANVAS AREA (5/6 width) -->
                <div class="lg:w-5/6 w-full" style="position: relative;">
                    <div id="map-card-wrapper" class="map-card-container">
                        <div class="map-container" id="map-container">
                            <img id="map-background" class="w-full h-full object-contain rounded-xl" alt="Delta Force Map" />
                            <canvas id="drawing-canvas" class="map-canvas rounded-xl"></canvas>
                            <div id="trash-can" class="absolute bottom-4 right-4 p-3 bg-red-700/80 rounded-full shadow-lg transition-all duration-200 z-40 hidden opacity-0 border border-red-900"
                                title="Drag icon here to delete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Modals (kept as you provided) -->
    <div id="brush-preview" class="fixed rounded-full pointer-events-none transition-opacity duration-100 ease-out hidden"
        style="border: 2px solid; z-index: 1000; top: 0; left: 0;">
    </div>

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-card p-6 rounded-xl shadow-2xl w-full max-w-sm border border-secondary">
            <p id="modal-message" class="text-lg mb-6 text-text font-semibold">Are you sure you want to clear all drawings? This cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition">
                    Cancel
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-600 transition">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-card p-6 rounded-xl shadow-2xl w-full max-w-lg border border-secondary">
            <h2 class="text-xl font-bold mb-4 text-primary">Import Strategy Plan (Select JSON File)</h2>
            <p class="text-sm text-text mb-4">Select the **.json** file you previously exported.</p>
            <input type="file" id="import-file-input" accept=".json" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-text file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-blue-600"/>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="import-modal-cancel" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition">
                    Cancel
                </button>
                <button id="import-modal-action" class="px-4 py-2 bg-indigo-700 text-white font-semibold rounded-lg hover:bg-indigo-600 transition" disabled>
                    Load Plan
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIGURATION ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth, db, isLoginView = true;

        // --- DOM Elements ---
        const authUi = document.getElementById('auth-ui');
        const mainWrapper = document.getElementById('main-wrapper');
        const authForm = document.getElementById('auth-form');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authActionBtn = document.getElementById('auth-action-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authTitle = document.getElementById('auth-title');
        const passwordHint = document.getElementById('password-hint');
        const authMessageBox = document.getElementById('auth-message-box');
        const logoutBtn = document.getElementById('logout-btn');
        const anonUserIdDisplay = document.getElementById('anon-user-id');
        const loggedInUserIdDisplay = document.getElementById('logged-in-user-id');

        // --- UTILITY FUNCTIONS ---

        function displayMessage(message, isError) {
            authMessageBox.textContent = message;
            authMessageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (isError) {
                authMessageBox.classList.add('bg-red-100', 'text-red-800');
            } else {
                authMessageBox.classList.add('bg-green-100', 'text-green-800');
            }
        }

        function clearMessages() {
            authMessageBox.classList.add('hidden');
        }

        // --- AUTHENTICATION HANDLERS ---

        const toggleView = () => {
            isLoginView = !isLoginView;
            authTitle.textContent = isLoginView ? 'Member Login' : 'Create Account';
            authActionBtn.textContent = isLoginView ? 'Log In' : 'Create Account';
            authToggleBtn.textContent = isLoginView 
                ? "Don't have an account? Sign Up now."
                : "Back to Login";
            
            passwordHint.classList.toggle('hidden', isLoginView);
            clearMessages();
        };

        const handleAuthAction = async (e) => {
            e.preventDefault();
            clearMessages();
            
            const email = authEmail.value;
            const password = authPassword.value;

            if (!auth || !email || !password) {
                displayMessage("Please enter email and password.", true);
                return;
            }

            try {
                if (isLoginView) {
                    // LOGIN
                    await signInWithEmailAndPassword(auth, email, password);
                    displayMessage("Login successful!", false);
                } else {
                    // SIGN UP
                    if (password.length < 6) {
                        displayMessage("Password must be at least 6 characters long.", true);
                        return;
                    }
                    await createUserWithEmailAndPassword(auth, email, password);
                    displayMessage("Account created and logged in successfully!", false);
                }
                authEmail.value = '';
                authPassword.value = '';
            } catch (e) {
                let errorMsg = 'An authentication error occurred.';
                if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password') {
                    errorMsg = 'Invalid credentials.';
                } else if (e.code === 'auth/email-already-in-use') {
                    errorMsg = 'This email is already registered.';
                    if (!isLoginView) toggleView();
                } else if (e.code === 'auth/weak-password') {
                    errorMsg = 'Password is too weak (min 6 characters).';
                } else {
                    errorMsg = e.message;
                }
                displayMessage(errorMsg, true);
                console.error("Auth Error:", e);
            }
        };

        const handleLogout = async () => {
            if (auth) {
                try {
                    await signOut(auth);
                    console.log("Logged out.");
                    clearMessages();
                    // UI handled by onAuthStateChanged
                } catch (e) {
                    console.error("Logout failed:", e);
                }
            }
        };

        // --- FIREBASE INITIALIZATION & STATE LISTENER ---

        const initFirebase = () => {
            if (Object.keys(firebaseConfig).length === 0) {
                displayMessage("ERROR: Firebase configuration is missing.", true);
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Initial authentication attempt
                const attemptAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Initial auth failed, attempting anonymous:", e.message);
                        if (!auth.currentUser) {
                           await signInAnonymously(auth);
                        }
                    }
                };
                
                // Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user && !user.isAnonymous) {
                        // Logged in with a permanent account (Email/Password)
                        authUi.classList.add('hidden');
                        mainWrapper.classList.remove('hidden');
                        loggedInUserIdDisplay.textContent = user.email;
                        // You can now use user.uid to load and save user-specific planner data
                    } else if (user && user.isAnonymous) {
                        // Only logged in anonymously
                        authUi.classList.classList.remove('hidden');
                        mainWrapper.classList.add('hidden');
                        anonUserIdDisplay.textContent = user.uid || 'N/A';
                    } else {
                        // Logged out
                        authUi.classList.remove('hidden');
                        mainWrapper.classList.add('hidden');
                    }
                });

                attemptAuth();

                // Attach event listeners after auth is initialized
                authForm.addEventListener('submit', handleAuthAction);
                authToggleBtn.addEventListener('click', toggleView);
                logoutBtn.addEventListener('click', handleLogout);

            } catch (e) {
                displayMessage(`Firebase Init Error: ${e.message}`, true);
            }
        };

        // Start everything when the DOM is ready
        document.addEventListener('DOMContentLoaded', initFirebase);

        // --- Placeholder functions for map logic (to prevent errors in existing HTML) ---
        // NOTE: You need to implement the actual canvas drawing, undo/redo, and data saving logic here.
        document.getElementById('map-select').innerHTML = '<option value="">Select Map</option><option value="map1">Space City</option>';
        document.getElementById('sector-select').innerHTML = '<option value="">Select Sector</option><option value="sectorA">Sector Alpha</option>';
        document.getElementById('sequence-select').innerHTML = '<option value="">Select Sequence</option><option value="seq1">Phase 1: Entry</option>';
        document.getElementById('operator-icons').innerHTML = '<span class="placed-icon" style="background-color:#1d9bf0;">O1</span><span class="placed-icon" style="background-color:#059669;">O2</span>';
        document.getElementById('utility-icons').innerHTML = '<span class="placed-icon" style="background-color:#f59e0b;">M</span><span class="placed-icon" style="background-color:#f43f5e;">G</span>';
        document.getElementById('vehicle-icons').innerHTML = '<span class="placed-icon" style="background-color:#9333ea;">V</span><span class="placed-icon" style="background-color:#f97316;">T</span>';
        document.getElementById('map-background').src = "https://placehold.co/1280x720/161b22/c9d1d9?text=Map+Goes+Here";

        document.getElementById('tool-pen').addEventListener('click', () => { /* tool logic */ });
        document.getElementById('tool-place').addEventListener('click', () => { /* tool logic */ });
        document.getElementById('tool-text').addEventListener('click', () => { /* tool logic */ });
        document.getElementById('tool-move').addEventListener('click', () => { /* tool logic */ });
        document.getElementById('tool-eraser').addEventListener('click', () => { /* tool logic */ });
        document.getElementById('undo-button').addEventListener('click', () => { /* undo logic */ });
        document.getElementById('redo-button').addEventListener('click', () => { /* redo logic */ });
        document.getElementById('clear-lines').addEventListener('click', () => { /* clear lines logic */ });
        document.getElementById('clear-map').addEventListener('click', () => { /* clear all logic */ });
        document.getElementById('export-data').addEventListener('click', () => { /* export logic */ });
        document.getElementById('import-data').addEventListener('click', () => { /* import logic */ });
        document.getElementById('save-map').addEventListener('click', () => { /* save image logic */ });

    </script>

</body>
</html>
